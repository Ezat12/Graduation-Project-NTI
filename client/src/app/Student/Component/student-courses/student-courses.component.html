<div class="courses-container">
  <div class="courses-header">
    <div class="header-content">
      <h1 class="page-title">Available Courses</h1>
      <p class="page-subtitle">Browse and enroll in our courses</p>
    </div>
    <div class="search-filter-section">
      <div class="search-box">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          ></path>
        </svg>
        <input
          type="text"
          placeholder="Search courses..."
          class="search-input"
          (input)="onSearch($event)"
        />
      </div>
    </div>
  </div>

  <div class="courses-layout">
    <div class="filters-sidebar">
      <div class="filters-header">
        <h3 class="filters-title">Filters</h3>
        <button class="reset-filters" (click)="resetFilters()">Reset All</button>
      </div>

      <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filters-form">
        <div class="filter-group">
          <label class="filter-label">Category</label>
          <select class="filter-select" formControlName="category">
            <option value="">All Categories</option>
            @for (cat of categories; track cat) {
            <option [value]="cat">{{ cat }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Language</label>
          <select class="filter-select" formControlName="language">
            <option value="">All Languages</option>
            @for (lang of languages; track lang) {
            <option [value]="lang">{{ lang }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Minimum Rating</label>
          <div class="rating-filter">
            @for (i of [5,4,3,2,1]; track i) {
            <button
              type="button"
              class="rating-option"
              [class.active]="filterForm.get('rating')?.value === i.toString()"
              (click)="setRating(i)"
            >
              <span class="stars">
                @for (star of [1,2,3,4,5]; track star) {
                <svg
                  class="star-icon"
                  [class.filled]="star <= i"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"
                  ></path>
                </svg>
                }
              </span>
              <span class="rating-text">& Up</span>
            </button>
            }
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Price Range</label>
          <div class="price-inputs">
            <div class="price-input-group">
              <span class="price-prefix">Min</span>
              <input
                type="number"
                class="price-input"
                formControlName="minPrice"
                placeholder="0"
                min="0"
              />
            </div>
            <div class="price-input-group">
              <span class="price-prefix">Max</span>
              <input
                type="number"
                class="price-input"
                formControlName="maxPrice"
                placeholder="1000"
                min="0"
              />
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Level</label>
          <div class="level-options">
            @for (level of levels; track level) {
            <label class="level-option">
              <input
                type="checkbox"
                [value]="level"
                (change)="onLevelChange($event, level)"
                [checked]="selectedLevels.includes(level)"
              />
              <span class="checkmark"></span>
              {{ level }}
            </label>
            }
          </div>
        </div>

        <button type="submit" class="apply-filters-btn">Apply Filters</button>
      </form>
    </div>

    <div class="courses-content">
      @if (isLoading) {
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading courses...</p>
      </div>
      } @if (!isLoading) {
      <div class="courses-grid">
        @if (filteredCourses.length === 0) {
        <div class="empty-state">
          <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
            ></path>
          </svg>
          <h3 class="empty-title">No courses found</h3>
          <p class="empty-subtitle">Try adjusting your filters or search terms</p>
          <button class="empty-action-btn" (click)="resetFilters()">Reset Filters</button>
        </div>
        } @for (course of filteredCourses; track course._id) {
        <app-course-card [course]="course" (purchase)="onPurchase($event)"></app-course-card>
        }
      </div>
      }
    </div>
  </div>
</div>

@if (showPaymentForm && selectedCourse) {
<div class="payment-modal">
  <div class="modal-overlay" (click)="closePaymentForm()"></div>

  <div class="modal-content">
    <div class="modal-header">
      <h2>Complete Your Purchase</h2>
      <button type="button" class="close-btn" (click)="closePaymentForm()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <div class="course-summary">
      <div class="summary-header">
        <h3>Order Summary</h3>
      </div>
      <div class="summary-content">
        <div class="course-info">
          <img
            [src]="selectedCourse?.imageUrl || '/assets/default-course.jpg'"
            alt="Course image"
            class="course-thumbnail"
          />
          <div class="course-details">
            <h4>{{ selectedCourse?.title }}</h4>
            <p class="instructor">By {{ selectedCourse?.instructorId?.name }}</p>
          </div>
        </div>
        <div class="price-breakdown">
          <div class="price-item">
            <span>Course price</span>
            <span>{{ selectedCourse?.price | currency : 'USD' : 'symbol' : '1.0-0' }}</span>
          </div>
          <div class="price-item">
            <span>Platform fee</span>
            <span>$0.00</span>
          </div>
          <div class="price-item total">
            <span>Total</span>
            <span>{{ selectedCourse?.price | currency : 'USD' : 'symbol' : '1.0-0' }}</span>
          </div>
        </div>
      </div>
    </div>

    <form [formGroup]="paymentForm" (ngSubmit)="pay()" class="payment-form">
      <div class="form-section">
        <h3>Card Information</h3>

        <div class="form-group">
          <label class="form-label">Card Number</label>
          <div class="card-input-wrapper">
            <input
              type="text"
              formControlName="cardNumber"
              class="form-input card-number"
              placeholder="1234 5678 9012 3456"
              maxlength="19"
              (input)="formatCardNumber($event)"
              [class.error]="cardNumber?.touched && cardNumber?.invalid"
            />
            <div class="card-icons">
              <div class="card-icon visa">ðŸ’³</div>
              <div class="card-icon mastercard">ðŸ’³</div>
              <div class="card-icon amex">ðŸ’³</div>
            </div>
          </div>
          <div class="error-messages" *ngIf="cardNumber?.touched && cardNumber?.invalid">
            <div class="error-text" *ngIf="cardNumber?.errors?.['required']">
              Card number is required
            </div>
            <div
              class="error-text"
              *ngIf="cardNumber?.errors?.['pattern'] || cardNumber?.errors?.['minlength']"
            >
              Please enter a valid 16-digit card number
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Expiry Date</label>
            <input
              type="text"
              formControlName="expiryDate"
              class="form-input"
              placeholder="MM/YY"
              maxlength="5"
              (input)="formatExpiryDate($event)"
              [class.error]="expiryDate?.touched && expiryDate?.invalid"
            />
            <div class="error-messages" *ngIf="expiryDate?.touched && expiryDate?.invalid">
              <div class="error-text" *ngIf="expiryDate?.errors?.['required']">
                Expiry date is required
              </div>
              <div class="error-text" *ngIf="expiryDate?.errors?.['pattern']">
                Please enter a valid expiry date (MM/YY)
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">CVC</label>
            <input
              type="text"
              formControlName="cvc"
              class="form-input"
              placeholder="123"
              maxlength="4"
              (input)="formatCVC($event)"
              [class.error]="cvc?.touched && cvc?.invalid"
            />
            <div class="error-messages" *ngIf="cvc?.touched && cvc?.invalid">
              <div class="error-text" *ngIf="cvc?.errors?.['required']">CVC is required</div>
              <div class="error-text" *ngIf="cvc?.errors?.['pattern']">
                Please enter a valid 3 or 4 digit CVC
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>Cardholder Information</h3>

        <div class="form-group">
          <label class="form-label">Full Name on Card</label>
          <input
            type="text"
            formControlName="cardholderName"
            class="form-input"
            placeholder="John Doe"
            [class.error]="cardholderName?.touched && cardholderName?.invalid"
          />
          <div class="error-messages" *ngIf="cardholderName?.touched && cardholderName?.invalid">
            <div class="error-text" *ngIf="cardholderName?.errors?.['required']">
              Cardholder name is required
            </div>
            <div class="error-text" *ngIf="cardholderName?.errors?.['minlength']">
              Name must be at least 2 characters
            </div>
            <div class="error-text" *ngIf="cardholderName?.errors?.['pattern']">
              Name can only contain letters and spaces
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Country or Region</label>
          <select
            formControlName="country"
            class="form-select"
            [class.error]="country?.touched && country?.invalid"
          >
            <option value="">Select Country</option>
            <option value="US">United States</option>
            <option value="CA">Canada</option>
            <option value="GB">United Kingdom</option>
            <option value="AU">Australia</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="IN">India</option>
            <option value="EG">Egypt</option>
            <option value="SA">Saudi Arabia</option>
            <option value="AE">United Arab Emirates</option>
          </select>
          <div class="error-messages" *ngIf="country?.touched && country?.invalid">
            <div class="error-text" *ngIf="country?.errors?.['required']">Country is required</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Email Address <span class="optional">(Optional)</span></label>
          <input
            type="email"
            formControlName="email"
            class="form-input"
            placeholder="your@email.com"
            [class.error]="email?.touched && email?.invalid"
          />
          <div class="error-messages" *ngIf="email?.touched && email?.invalid">
            <div class="error-text" *ngIf="email?.errors?.['email']">
              Please enter a valid email address
            </div>
          </div>
          <div class="helper-text">Receipt will be sent to this email</div>
        </div>
      </div>

      <div class="security-notice">
        <div class="lock-icon">ðŸ”’</div>
        <div class="security-text">
          <strong>Your payment is secure</strong>
          <p>We use industry-standard encryption to protect your information</p>
        </div>
      </div>

      <div class="form-actions">
        <button
          type="submit"
          class="pay-button"
          [class.disabled]="paymentForm.invalid"
          [attr.disabled]="paymentForm.invalid ? true : null"
        >
          Pay {{ selectedCourse?.price | currency : 'USD' : 'symbol' : '1.0-0' }}
        </button>

        <p class="payment-notice">
          By completing your purchase you agree to our
          <a href="#" class="link">Terms of Service</a>
        </p>
      </div>
    </form>
  </div>
</div>
}
