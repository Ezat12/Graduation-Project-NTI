<div class="progress-course-container">
  @if (isLoading) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading course content...</p>
  </div>
  }

  @else if (errorMessage) {
  <div class="error-container">
    <div class="error-icon">⚠️</div>
    <h3>Course Not Found</h3>
    <p>{{ errorMessage }}</p>
    <button class="btn-primary" routerLink="/my-courses">Back to My Courses</button>
  </div>
  }

  @else if (course) {
  <div class="course-layout">
    <div class="main-content">
      @if (selectedLecture) {
      <div class="video-section">
        <div class="video-container">
          <video controls class="video-player">
            <source [src]="selectedLecture.videoUrl" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
        <div class="video-info">
          <h2>{{ selectedLecture.title }}</h2>
          @if (selectedLecture.freePreview) {
          <span class="free-badge">Free Preview</span>
          }
        </div>
      </div>
      }

      <div class="description-section">
        <h3>About this course</h3>
        <p>{{ course.description }}</p>

        <div class="course-stats">
          <div class="stat">
            <strong>Rating:</strong>
            <span class="rating">
              {{ course.rating.toFixed(1) }} ⭐ ({{ course.reviewsCount }} reviews)
            </span>
          </div>
          <div class="stat">
            <strong>Level:</strong>
            <span class="level-badge">{{ course.level }}</span>
          </div>
          <div class="stat">
            <strong>Language:</strong>
            <span>{{ course.language.join(', ') }}</span>
          </div>
          <div class="stat">
            <strong>Enrollments:</strong>
            <span>{{ course.enrollments }} students</span>
          </div>
        </div>

        <div class="objectives">
          <h4>What you'll learn</h4>
          <ul>
            @for (objective of course.objective; track $index) {
            <li>{{ objective }}</li>
            }
          </ul>
        </div>

        <div class="reviews-section">
          <div class="reviews-header">
            <h3>Student Reviews</h3>
            <button class="btn-review" (click)="openReviewModal()">⭐ Write a Review</button>
          </div>

          @if (reviews.length === 0) {
          <div class="no-reviews">
            <p>No reviews yet. Be the first to review this course!</p>
          </div>
          } @else {
          <div class="reviews-list">
            @for (review of reviews; track review._id) {
            <div class="review-item">
              <div class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-avatar">
                    {{ review.userName?.charAt(0) || 'U' }}
                  </div>
                  <div class="reviewer-details">
                    <strong>{{ review.userName || 'Anonymous' }}</strong>
                    <span class="review-date">{{ formatDate(review.createdAt!) }}</span>
                  </div>
                </div>
                <div class="review-rating">
                  <span class="stars">{{ getStarRating(review.rating) }}</span>
                  <span class="rating-number">({{ review.rating }}.0)</span>
                </div>
              </div>
              <div class="review-comment">
                {{ review.comment }}
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="progress-card">
        <h3>Your Progress</h3>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
        </div>
        <p class="progress-text">
          {{ getCompletedLecturesCount() }} of {{ course.lectures.length }} lectures completed ({{
            getProgressPercentage().toFixed(0)
          }}%)
        </p>
      </div>

      <div class="lectures-card">
        <h3>Course Content</h3>
        <div class="lectures-list">
          @for (lecture of course.lectures; track lecture._id; let i = $index) {
          <div
            class="lecture-item"
            [class.active]="selectedLecture?._id === lecture._id"
            [class.completed]="lecture.completed"
            (click)="selectLecture(lecture)"
          >
            <div class="lecture-info">
              <span class="lecture-number">{{ i + 1 }}</span>
              <div class="lecture-details">
                <h4>{{ lecture.title }}</h4>
                @if (lecture.freePreview) {
                <span class="preview-badge">Free Preview</span>
                }
              </div>
            </div>
            <div class="lecture-actions">
              <button
                class="btn-complete"
                (click)="markAsCompleted(lecture); $event.stopPropagation()"
                [class.completed]="lecture.completed"
              >
                {{ lecture.completed ? '✓' : '○' }}
              </button>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  }

  @if (showReviewModal) {
  <div class="modal-overlay" (click)="closeReviewModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Write a Review</h3>
        <button class="btn-close" (click)="closeReviewModal()">×</button>
      </div>

      <div class="modal-body">
        <div class="rating-section">
          <label>How would you rate this course?</label>
          <div class="stars">
            @for (star of [1,2,3,4,5]; track star) {
            <span
              class="star"
              [class.active]="star <= (hoverRating || review.rating)"
              (click)="setRating(star)"
              (mouseenter)="setHoverRating(star)"
              (mouseleave)="setHoverRating(0)"
            >
              ★
            </span>
            }
          </div>
          <div class="rating-label">
            @if (review.rating === 0) {
            <span>Select a rating</span>
            } @else {
            <span>{{ review.rating }} star{{ review.rating > 1 ? 's' : '' }}</span>
            }
          </div>
        </div>

        <div class="comment-section">
          <label for="comment">Your Review</label>
          <textarea
            id="comment"
            [(ngModel)]="review.comment"
            placeholder="Share your experience with this course. What did you like? What could be improved?"
            rows="5"
            maxlength="500"
          ></textarea>
          <div class="char-count">{{ review.comment.length }}/500</div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeReviewModal()" [disabled]="isSubmittingReview">
          Cancel
        </button>
        <button
          class="btn-primary"
          (click)="submitReview()"
          [disabled]="isSubmittingReview || review.rating === 0 || !review.comment.trim()"
        >
          @if (isSubmittingReview) {
          <span class="loading-text">Submitting...</span>
          } @else {
          <span>Submit Review</span>
          }
        </button>
      </div>
    </div>
  </div>
  }
</div>
