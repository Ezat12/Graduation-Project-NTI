<div class="create-course-container">
  <div class="header-section">
    <div class="header-content">
      <button (click)="cancel()" class="back-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Courses
      </button>
      <h1 class="page-title">Edit Course</h1>
      <p class="page-subtitle">Update your course details and lectures</p>
    </div>
  </div>

  <div class="form-container">
    @if (isLoading) {
      <div class="message">Loading course...</div>
    } @else {
      <form (ngSubmit)="save()" class="course-form">
        @if (errorMessage) {
          <div class="message error-message">{{ errorMessage }}</div>
        }

        <div class="form-section">
          <h3 class="section-title">Basic Information</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <label class="form-label">Course Title *</label>
              <input class="form-input" [(ngModel)]="form.title" name="title" required minlength="4" placeholder="Enter course title" />
            </div>
            <div class="form-group full-width">
              <label class="form-label">Course Description *</label>
              <textarea class="form-textarea" [(ngModel)]="form.description" name="description" rows="4" placeholder="Describe your course"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Price ($) *</label>
              <input class="form-input" type="number" [(ngModel)]="form.price" name="price" min="0" step="0.01" />
            </div>
            <div class="form-group">
              <label class="form-label">Level *</label>
              <select class="form-select" [(ngModel)]="form.level" name="level">
                <option value="">Select Level</option>
                <option value="Beginner">Beginner</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
                <option value="All levels">All levels</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label class="form-label">Course Image</label>
              <input type="file" id="courseImage" (change)="onImageSelected($event)" accept="image/*" class="hidden-file-input" />

              <div class="image-actions-row">
                <button type="button" class="btn btn-outline" (click)="triggerImagePicker()">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v9m0-9V3m0 9H3m9 0h9"/></svg>
                  Update Image
                </button>
                <button type="button" class="btn btn-danger" (click)="removeImage()">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  Delete
                </button>
              </div>

              @if (uploadingImage) {
                <div class="upload-status"><div class="upload-spinner"></div><span class="upload-text">Uploading image...</span></div>
              } @else if (form.imageUrl) {
                <div class="file-preview media-full">
                  <img [src]="form.imageUrl" alt="Course" class="media-full-img" />
                </div>
              }
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">Course Categories</h3>
          @if (isLoadingCategories) {
            <div class="loading-categories"><div class="loading-spinner"></div> <span>Loading categories...</span></div>
          } @else {
            <div class="categories-grid">
              @for (category of (categories || []); track category._id) {
                <div class="category-item" [class.selected]="isCategorySelected(category._id)">
                  <label class="category-checkbox">
                    <input type="checkbox" class="category-input" [checked]="isCategorySelected(category._id)" (change)="toggleCategory(category._id)" />
                    <span class="category-name">{{ category.name }}</span>
                  </label>
                  @if (category.description) {
                    <p class="category-description">{{ category.description }}</p>
                  }
                </div>
              }
            </div>
            @if ((categories || []).length === 0) {
              <div class="no-categories"><p>No categories available</p></div>
            }
          }
        </div>

        <div class="form-section">
          <h3 class="section-title">Course Objectives</h3>
          <div class="form-group full-width">
            <label class="form-label">Learning Objectives</label>
            <div class="objectives-container">
              @for (obj of form.objective; let i = $index; track i) {
                <div class="objective-item">
                  <input class="form-input" [(ngModel)]="form.objective[i]" [name]="'objective_'+i" placeholder="Enter a learning objective" />
                  <button type="button" (click)="removeObjective(i)" class="remove-btn">Remove</button>
                </div>
              }
              <button type="button" (click)="addObjective()" class="btn btn-outline">Add Objective</button>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">Course Lectures</h3>
          <div class="lectures-container">
            @for (lec of form.lectures; let i = $index; track i) {
              <div class="lecture-item">
                <h4 class="lecture-title">Lecture {{ i + 1 }}</h4>
                <div class="form-grid">
                  <div class="form-group full-width">
                    <label class="form-label">Lecture Title *</label>
                    <input class="form-input" [(ngModel)]="form.lectures[i].title" [name]="'lecture_title_'+i" required minlength="4" placeholder="Lecture title" />
                  </div>
                  <div class="form-group full-width">
                    <label class="form-label">Lecture Video *</label>
                    <input type="file" [id]="'lectureVideo_'+i" (change)="onVideoSelected($event, i)" accept="video/*" class="hidden-file-input" />
                    <div class="video-actions-row">
                      <button type="button" class="btn btn-outline" (click)="triggerVideoPicker(i)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v9m0-9V3m0 9H3m9 0h9"/></svg>
                        Update Video
                      </button>
                      <button type="button" class="btn btn-danger" (click)="removeVideo(i)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        Delete
                      </button>
                    </div>

                    @if (form.lectures[i].uploadingVideo) {
                      <div class="upload-status"><div class="upload-spinner"></div><span class="upload-text">Uploading video...</span></div>
                    } @else if (form.lectures[i].videoUrl) {
                      <div class="file-preview media-full">
                        <video [src]="form.lectures[i].videoUrl" controls class="media-full-video"></video>
                      </div>
                    }
                  </div>
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" [(ngModel)]="form.lectures[i].freePreview" [name]="'lecture_free_'+i" class="checkbox-input" />
                      Free Preview
                    </label>
                  </div>
                </div>
                <button type="button" (click)="removeLecture(i)" class="btn btn-danger mt-4">Remove Lecture</button>
              </div>
            }
            <button type="button" (click)="addLecture()" class="btn btn-outline full-width">Add Lecture</button>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" (click)="cancel()" class="btn btn-secondary" [disabled]="isSaving">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="isSaving || isAnyLectureUploading()">Save Changes</button>
        </div>
      </form>
    }
  </div>
</div>


